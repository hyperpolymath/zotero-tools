= Zotero Safe Storage

image:https://img.shields.io/badge/License-PMPL--1.0-blue.svg[License: PMPL-1.0,link="https://github.com/hyperpolymath/palimpsest-license"]
image:https://img.shields.io/badge/Philosophy-Palimpsest-indigo.svg[Palimpsest,link="https://github.com/hyperpolymath/palimpsest-license"]


:toc: macro
:toc-title: Contents
:toclevels: 3
:icons: font
:source-highlighter: rouge
:experimental:

[.lead]
*Never lose your research library again.* Bulletproof Zotero data storage with containerization, distributed sync, and paranoid backup strategies.

[IMPORTANT]
====
If you're a PhD student reading this the day before your viva: *breathe*. Your data is going to be fine. This project exists precisely because we understand that terror.
====

toc::[]

== The Problem

Zotero uses SQLite for its database. SQLite is excellent—fast, reliable, ACID-compliant. But it has one critical weakness: *it was never designed for cloud sync*.

When you put `zotero.sqlite` in Dropbox, OneDrive, Google Drive, or iCloud, you're playing Russian roulette with your research:

[cols="1,3"]
|===
|Failure Mode |What Happens

|Partial Write Sync
|Cloud tool reads database mid-transaction, syncs corrupted half-written state

|Journal Desync
|`zotero.sqlite-journal` syncs separately from main DB; crash recovery impossible

|WAL Corruption
|Write-Ahead Log and shared memory files split across versions

|Lock Breaking
|Two machines open Zotero simultaneously; both write; corruption guaranteed
|===

The result: `"database disk image is malformed"` — and potentially years of carefully curated references gone.

=== Why This Matters

* *6 years of PhD research* — gone
* *Carefully tagged and annotated PDFs* — inaccessible
* *The night before your thesis deadline* — maximum stress

This project ensures that *never happens*.

== The Solution

Zotero Safe Storage provides multiple layers of protection:

[source]
----
┌─────────────────────────────────────────────────────────────────┐
│                    ZOTERO SAFE STORAGE                          │
├─────────────────────────────────────────────────────────────────┤
│  Layer 5: DISASTER RECOVERY                                     │
│  ├── Geographically distributed backups (B2, S3, Backblaze)     │
│  ├── Encrypted offsite snapshots                                │
│  └── Point-in-time recovery (hourly/daily/weekly retention)     │
├─────────────────────────────────────────────────────────────────┤
│  Layer 4: CONTINUOUS BACKUP                                     │
│  ├── Real-time SQLite streaming replication (Litestream)        │
│  ├── Automatic versioned snapshots                              │
│  └── Pre-sync integrity verification                            │
├─────────────────────────────────────────────────────────────────┤
│  Layer 3: SYNC-SAFE REPLICATION                                 │
│  ├── LiteFS distributed SQLite (multi-device safe)              │
│  ├── Optional: SurrealDB metadata mirror                        │
│  └── Conflict-free replicated data types (CRDTs)                │
├─────────────────────────────────────────────────────────────────┤
│  Layer 2: FILESYSTEM PROTECTION                                 │
│  ├── Copy-on-Write filesystem (Btrfs/ZFS snapshots)             │
│  ├── Immutable container layers                                 │
│  └── Atomic operations only                                     │
├─────────────────────────────────────────────────────────────────┤
│  Layer 1: CONTAINERIZATION                                      │
│  ├── Wolfi-based minimal container                              │
│  ├── nerdctl/containerd runtime                                 │
│  ├── Isolated data volumes                                      │
│  └── Reproducible via Guix/Nix                                  │
└─────────────────────────────────────────────────────────────────┘
----

== Architecture

=== Core Components

[source,mermaid]
----
graph TB
    subgraph "Your Devices"
        A[Laptop] --> L[LiteFS Primary]
        B[Desktop] --> L2[LiteFS Replica]
        C[Tablet] --> L3[LiteFS Replica]
    end

    subgraph "Container Stack"
        L --> Z[Zotero Container<br/>Wolfi + nerdctl]
        Z --> DB[(zotero.sqlite)]
    end

    subgraph "Backup Layers"
        DB --> LS[Litestream]
        LS --> S3[(S3/B2 Backup)]
        DB --> SNAP[Btrfs Snapshots]
        SNAP --> LOCAL[(Local Backup)]
    end

    subgraph "Optional Sync"
        DB --> SURREAL[(SurrealDB Mirror)]
        SURREAL --> SYNC[Multi-device Sync]
    end
----

=== Technology Stack

[cols="1,1,2"]
|===
|Component |Technology |Purpose

|Container Runtime
|nerdctl + containerd
|Rootless containers, no Docker daemon

|Base Image
|Wolfi (Chainguard)
|Minimal attack surface, daily CVE patches

|SQLite Replication
|LiteFS
|Distributed SQLite with automatic failover

|Streaming Backup
|Litestream
|Continuous SQLite replication to S3/B2

|Filesystem
|Btrfs (CoW)
|Instant snapshots, self-healing

|Package Management
|Guix + Nix
|Reproducible builds, rollback capability

|Optional Sync DB
|SurrealDB
|CRDT-based sync for metadata

|Attachments
|WebDAV / Syncthing
|Safe file sync (not database!)
|===

== Quick Start

=== Prerequisites

[source,bash]
----
# Fedora Atomic/Silverblue
rpm-ostree install nerdctl

# Or standard Fedora
sudo dnf install nerdctl containerd
----

=== Installation

[source,bash]
----
# Clone the repository
git clone https://github.com/hyperpolymath/zotero-safe-storage.git
cd zotero-safe-storage

# Build the container
./scripts/build.sh

# Initialize with your existing Zotero data
./scripts/init.sh --import ~/.zotero/zotero

# Start Zotero
./scripts/start.sh
----

=== Configuration

[source,toml]
----
# config/zotero-safe.toml

[backup]
# How often to snapshot (minimum: 1 hour)
snapshot_interval = "1h"

# Keep this many snapshots
retention_count = 168  # 1 week of hourly snapshots

# Cloud backup destination (optional but recommended)
litestream_replica = "s3://your-bucket/zotero-backup"

[sync]
# Enable multi-device sync via LiteFS
litefs_enabled = true
litefs_primary = "laptop.local"

# Optional: Mirror to SurrealDB for CRDT sync
surrealdb_enabled = false
surrealdb_url = "ws://localhost:8000"

[filesystem]
# Use Btrfs snapshots if available
btrfs_snapshots = true
snapshot_subvolume = "/var/lib/zotero-safe"
----

== Backup Strategies

=== Strategy 1: Local Snapshots (Minimum)

Even without cloud backup, you get protection:

[source,bash]
----
# Automatic hourly Btrfs snapshots
/var/lib/zotero-safe/.snapshots/
├── hourly.0/    # Most recent
├── hourly.1/
├── hourly.2/
...
├── daily.0/     # Daily snapshots kept for 30 days
├── weekly.0/    # Weekly snapshots kept for 52 weeks
----

*Recovery:*
[source,bash]
----
./scripts/restore.sh --from hourly.3
----

=== Strategy 2: Litestream (Recommended)

Continuous streaming backup to cloud storage:

[source,bash]
----
# Backups stream in real-time to:
# - Backblaze B2 ($0.005/GB/month)
# - AWS S3
# - Any S3-compatible storage (MinIO, Wasabi)

# Recovery from any point in time:
./scripts/restore.sh --from litestream --timestamp "2025-01-01T12:00:00Z"
----

=== Strategy 3: Full Paranoia Mode

For those who *really* can't afford to lose data:

[source,bash]
----
# Enable all backup layers
./scripts/configure.sh --paranoia

# This enables:
# ✓ Hourly local Btrfs snapshots
# ✓ Real-time Litestream to primary cloud
# ✓ Daily encrypted backup to secondary cloud
# ✓ Weekly backup to third geographic region
# ✓ Pre-operation integrity checks
# ✓ Post-operation verification
# ✓ Automatic corruption detection and alert
----

== Multi-Device Sync

=== The Safe Way

Unlike putting SQLite in Dropbox, LiteFS provides *proper* distributed SQLite:

[source]
----
┌──────────────┐         ┌──────────────┐
│   Laptop     │◄───────►│   Desktop    │
│  (Primary)   │  FUSE   │  (Replica)   │
│              │         │              │
│ zotero.sqlite│         │ zotero.sqlite│
│   (R/W)      │         │   (R/O)*     │
└──────────────┘         └──────────────┘

* Replica promotes to primary automatically if laptop offline
----

=== Setup Multi-Device

[source,bash]
----
# On primary device (e.g., laptop)
./scripts/litefs-init.sh --role primary --advertise laptop.local

# On secondary devices
./scripts/litefs-init.sh --role replica --primary laptop.local
----

== Integrity Verification

=== Automatic Checks

Every operation includes integrity verification:

[source,bash]
----
# Before any sync/backup
sqlite3 zotero.sqlite "PRAGMA integrity_check;"
sqlite3 zotero.sqlite "PRAGMA foreign_key_check;"

# Checksum verification
sha256sum zotero.sqlite > .integrity/current.sha256
----

=== Manual Verification

[source,bash]
----
# Full integrity report
./scripts/verify.sh

# Output:
# ✓ SQLite integrity check: PASSED
# ✓ Foreign key constraints: PASSED
# ✓ Checksum matches last backup: PASSED
# ✓ Litestream replication lag: 0.3s
# ✓ Last successful backup: 2025-01-01 23:45:00
# ✓ Backup verification (restore test): PASSED
----

== Emergency Recovery

=== Scenario: "Database is corrupted!"

Don't panic. You have multiple recovery paths:

[source,bash]
----
# Option 1: Restore from most recent snapshot
./scripts/restore.sh --from latest

# Option 2: Restore from specific time
./scripts/restore.sh --from litestream --timestamp "1 hour ago"

# Option 3: Restore from daily backup
./scripts/restore.sh --from daily.1

# Option 4: Full disaster recovery from offsite
./scripts/disaster-recovery.sh --from s3://backup-bucket/zotero
----

=== Scenario: "I deleted something important!"

[source,bash]
----
# Browse snapshots to find the item
./scripts/browse-snapshots.sh

# Export specific items from old snapshot
./scripts/export-items.sh --from hourly.5 --collection "PhD Thesis"
----

=== Scenario: "Everything is on fire!"

[source,bash]
----
# Nuclear option: Full restore from scratch
./scripts/disaster-recovery.sh --full --from offsite

# This will:
# 1. Download latest verified backup
# 2. Verify integrity before restore
# 3. Restore database
# 4. Restore attachments
# 5. Verify final state
----

== Philosophy

=== Defense in Depth

No single point of failure. Every layer assumes the layer below it *will* fail:

1. **Container fails?** → Filesystem snapshots survive
2. **Filesystem fails?** → Litestream backups survive
3. **Cloud region fails?** → Geographic redundancy
4. **Forgot to pay cloud bill?** → Local backups survive
5. **House burns down?** → Offsite backups survive

=== Verify, Don't Trust

Every backup is verified:

* Checksums on write
* Integrity checks on read
* Periodic restore tests (we actually restore and verify)
* Alerting on any anomaly

=== Simplicity Over Cleverness

* No complex sync protocols that might have edge cases
* SQLite stays as SQLite (no ORM, no abstraction)
* Standard tools (Btrfs, S3, SQLite) with decades of battle-testing
* Clear failure modes with clear recovery paths

== Contributing

See link:CONTRIBUTING.adoc[CONTRIBUTING.adoc] for guidelines.

== License

PMPL-1.0-or-later — because your research tools should be free as in freedom.

== Acknowledgments

* The Zotero team for building an excellent research tool
* Ben Johnson for https://litestream.io/[Litestream] and https://github.com/superfly/litefs[LiteFS]
* Every PhD student who lost data and shared their horror story so others could learn

---

[quote]
____
"The day before my viva, my Zotero database corrupted. I had no backup. I spent 12 hours manually rebuilding my references from PDFs. Don't be me."
— Anonymous PhD survivor
____

*This project ensures that story never repeats.*
